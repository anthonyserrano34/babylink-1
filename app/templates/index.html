<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BabyLink Score</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="app-container">

    <!-- 1) Overlay de dÃ©marrage -->
    <div id="name-overlay" class="overlay">
      <div class="overlay-content">
        <img src="/static/logo.png" alt="Logo" id="overlay-logo">
        <h2>Entrez les noms des joueurs</h2>
        <input id="left-name-input"  type="text" placeholder="Nom joueur gauche" />
        <input id="right-name-input" type="text" placeholder="Nom joueur droite" />
        <button id="start-button">DÃ©marrer la partie</button>
      </div>
    </div>

    <!-- 2) Indicateur de but -->
    <div id="goal-indicator" class="goal-indicator"></div>

    <!-- 3) Score -->
    <div class="scoreboard">
      <div class="score-player left">
        <span id="left-score">0</span>
      </div>
      <div class="separator">-</div>
      <div class="score-player right">
        <span id="right-score">0</span>
      </div>
    </div>

    <!-- 4) Message de victoire -->
    <div id="message" class="message" hidden></div>

    <!-- 5) Boutons de contrÃ´le -->
    <div class="controls">
      <button id="reset-button">Remettre Ã  zÃ©ro</button>
      <button id="newgame-button" hidden>Nouvelle partie</button>
    </div>
  </div>

  <audio id="win-sound" src="/static/win.mp3" preload="auto"></audio>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    let leftName = '', rightName = '';
    const nameOverlay = document.getElementById('name-overlay');
    const leftInput   = document.getElementById('left-name-input');
    const rightInput  = document.getElementById('right-name-input');
    const startBtn    = document.getElementById('start-button');
    const goalInd     = document.getElementById('goal-indicator');
    const leftEl      = document.getElementById('left-score');
    const rightEl     = document.getElementById('right-score');
    const resetBtn    = document.getElementById('reset-button');
    const newGameBtn  = document.getElementById('newgame-button');
    const messageEl   = document.getElementById('message');
    const winSound    = document.getElementById('win-sound');
    const WIN_SCORE   = 10;
    let gameOver      = false;

    // DÃ©marrage, saisie des noms
    startBtn.addEventListener('click', () => {
      if(!leftInput.value.trim()||!rightInput.value.trim()) return;
      leftName = leftInput.value.trim();
      rightName= rightInput.value.trim();
      nameOverlay.hidden = true;
      fetch('/reset',{method:'POST'});
    });

    // RÃ©ception des scores
    const socket = io();
    socket.on('score_update', data => {
      if(gameOver) return;
      leftEl.innerText  = data.left;
      rightEl.innerText = data.right;
      // Indicateur colorÃ©
      if(data.left>parseInt(leftEl.dataset.prev||0)) flash('left');
      if(data.right>parseInt(rightEl.dataset.prev||0)) flash('right');
      leftEl.dataset.prev = data.left;
      rightEl.dataset.prev= data.right;
      if(data.left>=WIN_SCORE||data.right>=WIN_SCORE){
        gameOver=true;
        celebrate(data.left>=WIN_SCORE?leftName:rightName);
      }
    });

    // Animation de lâ€™indicateur
    function flash(side){
      goalInd.className = 'goal-indicator '+side;
      goalInd.offsetWidth; // reflow
      goalInd.classList.add('active');
      setTimeout(()=>goalInd.classList.remove('active'),300);
    }

    // Reset / nouvelle partie
    resetBtn.addEventListener('click',()=>{
      if(!gameOver) fetch('/reset',{method:'POST'});
    });
    newGameBtn.addEventListener('click',()=>{
      gameOver=false;
      nameOverlay.hidden=false;
      leftEl.innerText=rightEl.innerText='0';
      resetBtn.hidden=false;
      newGameBtn.hidden=true;
      messageEl.hidden=true;
      fetch('/reset',{method:'POST'});
    });

    // CÃ©lÃ©bration
    function celebrate(winner){
      winSound.play();
      confetti({particleCount:200,spread:70,origin:{y:0.5}});
      messageEl.textContent=`Bravo ${winner} âš½ðŸŽ‰`;
      messageEl.hidden=false;
      resetBtn.hidden=true;
      newGameBtn.hidden=false;
    }
  </script>
</body>
</html>
